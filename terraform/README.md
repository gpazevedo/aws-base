# Application Infrastructure

This directory contains Terraform configuration for your application infrastructure with API Gateway as the standard entry point.

## Structure

- `main.tf` - Main Terraform configuration and provider setup
- `variables.tf` - Variable definitions
- `lambda.tf` - Lambda function resources
- `api-gateway.tf` - API Gateway configuration (standard mode)
- `outputs.tf` - Output values
- `modules/` - Reusable Terraform modules
  - `api-gateway-shared/` - Shared API Gateway configuration (rate limiting, logging, security)
  - `api-gateway-lambda/` - Lambda integration module (AWS_PROXY)
  - `api-gateway-apprunner/` - App Runner integration module (HTTP_PROXY)
- `environments/` - Environment-specific variable files
  - `dev.tfvars` - Development environment
  - `local.tfvars` - Local development environment
  - `test.tfvars` - Test environment
  - `prod.tfvars` - Production environment
  - `*-backend.hcl` - Backend configurations (generated by `make setup-terraform-backend`)

## Prerequisites

1. Bootstrap infrastructure must be deployed first:
   ```bash
   make bootstrap-create
   make bootstrap-init
   make bootstrap-apply
   make setup-terraform-backend
   ```

2. Docker image must be built and pushed to ECR:
   ```bash
   make docker-build
   make docker-push-dev
   ```

## Deployment Modes

### Standard Mode (Recommended for Cloud)
**API Gateway as entry point** - All traffic routed through API Gateway with rate limiting, logging, and security features.

```bash
# Development environment (API Gateway)
make app-init-dev
make app-plan-dev
make app-apply-dev
```

Configuration in `environments/dev.tfvars`:
```hcl
enable_api_gateway_standard = true
enable_direct_access        = false
```

### Local Development Mode
**Direct Lambda Function URLs** - For local testing and development without API Gateway overhead.

```bash
# Local environment (direct access)
terraform init -backend-config=environments/dev-backend.hcl
terraform plan -var-file="environments/local.tfvars"
terraform apply -var-file="environments/local.tfvars"
```

Configuration in `environments/local.tfvars`:
```hcl
enable_api_gateway_standard = false
enable_direct_access        = true
```

## API Gateway Features

### Rate Limiting
- Configurable burst and rate limits
- Per-API and per-method throttling
- Protects against abuse and controls costs

### Security
- Centralized entry point
- API keys support (optional)
- WAF integration ready (optional)
- Standardized CORS policies

### Observability
- CloudWatch access logs
- Structured logging
- X-Ray tracing support
- Per-API metrics

### Configuration Variables

```hcl
# Rate Limiting
api_throttle_burst_limit = 5000  # Burst limit
api_throttle_rate_limit  = 10000 # Requests per second

# Logging
api_log_retention_days = 7
api_logging_level      = "INFO"  # OFF, ERROR, INFO
enable_xray_tracing    = false

# CORS
cors_allow_origins = ["*"]
cors_allow_methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
cors_allow_headers = ["Content-Type", "Authorization"]
```

## Module Architecture

### Shared Module (api-gateway-shared)
- REST API creation
- Deployment and stage management
- Rate limiting and throttling
- CloudWatch logging
- X-Ray tracing
- Reusable across services

### Lambda Integration Module
- AWS_PROXY integration
- Lambda permissions
- CORS configuration
- Root path support

### App Runner Integration Module (future)
- HTTP_PROXY integration
- Direct App Runner routing
- Health check configuration
- VPC Link support

## Outputs

```bash
terraform output
```

Key outputs:
- `primary_endpoint` - The primary application endpoint (use this!)
- `api_gateway_url` - API Gateway invoke URL
- `lambda_function_url` - Lambda direct URL (if direct access enabled)
- `deployment_mode` - Current deployment mode
- `cloudwatch_log_group_api_gateway` - API Gateway logs
- `cloudwatch_log_group_lambda` - Lambda logs

## Environment-Specific Configuration

### Development (dev.tfvars)
- API Gateway enabled (standard mode)
- Lower rate limits (1000 burst, 500/sec)
- Verbose logging
- X-Ray tracing enabled
- Open CORS

### Local (local.tfvars)
- Direct Lambda Function URLs
- No API Gateway
- Fast iteration
- Open CORS

### Production (prod.tfvars)
- API Gateway enabled (standard mode)
- High rate limits (5000 burst, 10000/sec)
- Standard logging
- Restrictive CORS
- WAF integration (optional)

## Migration from Legacy

If upgrading from Lambda Function URLs:

1. API Gateway is now **standard** by default
2. Direct access (Function URLs) requires explicit `enable_direct_access = true`
3. Legacy `enable_api_gateway` still works but use `enable_api_gateway_standard` instead
4. Outputs have changed - use `primary_endpoint` for the main URL

## Customization

1. Edit `environments/{env}.tfvars` to customize settings per environment
2. Modify `lambda.tf` to add more Lambda functions
3. Adjust rate limiting and logging in tfvars
4. Add more resources as needed (databases, queues, etc.)

## Notes

- **API Gateway is the standard entry point** for cloud deployments
- Lambda Function URLs are **disabled by default** (use `enable_direct_access = true` for local dev)
- CloudWatch Logs are automatically configured for both API Gateway and Lambda
- First apply will fail if Docker image doesn't exist in ECR
- Rate limiting prevents abuse and controls costs
- X-Ray tracing helps with debugging (enable in dev/test)

## Troubleshooting

### No endpoint available
- Check `deployment_mode` output
- Ensure either `enable_api_gateway_standard = true` OR `enable_direct_access = true`

### API Gateway not deploying
- Verify bootstrap has `enable_lambda = true`
- Check IAM policies are attached to GitHub Actions roles
- Review CloudWatch logs for deployment errors

### Rate limiting too restrictive
- Adjust `api_throttle_burst_limit` and `api_throttle_rate_limit` in tfvars
- Check CloudWatch metrics for throttled requests

## Support

For issues or questions:
- Review the [API Gateway Standardization Plan](../API_GATEWAY_STANDARDIZATION_PLAN.md)
- Check module READMEs in `modules/*/README.md`
- Review CloudWatch logs for errors
