# Troubleshooting Guide

This guide provides solutions to common issues encountered with API Gateway, Docker dependencies, and deployments.

## ðŸ“š Table of Contents

- [API Gateway Issues](#api-gateway-issues)
- [Docker & Dependency Issues](#docker--dependency-issues)
- [Deployment Issues](#deployment-issues)
- [Debugging Tips](#debugging-tips)

---

## API Gateway Issues

### 1. "Missing Authentication Token"
**Symptoms:** `{"message": "Missing Authentication Token"}`
**Possible Causes & Solutions:**
- **Wrong Path:** Ensure you are using the correct path (e.g., `/api/health` vs `/health`).
- **Missing API Key:** If enabled, you must provide the `x-api-key` header.
  ```bash
  curl -H "x-api-key: $API_KEY" "$API_URL/health"
  ```
- **Method Not Allowed:** Ensure the HTTP method (GET, POST) is configured.

### 2. "Forbidden" or "Unauthorized"
**Symptoms:** 403 Forbidden
**Solution:**
- Verify API Key is valid and enabled.
- Check Usage Plan association in AWS Console.
- Ensure you are using the correct header name: `x-api-key` (not `X-API-Key`).

### 3. CORS Errors
**Symptoms:** Browser blocks request due to CORS policy.
**Solution:**
- Check `cors_allow_origins` in your `tfvars`.
- Ensure `OPTIONS` method is allowed.
- Add `x-api-key` to `cors_allow_headers` if using authentication.

### 4. 500 Internal Server Error
**Symptoms:** `{"message": "Internal server error"}`
**Solution:**
- **Check Lambda Logs:** The issue is likely in your code.
  ```bash
  aws logs tail /aws/lambda/<function-name> --follow
  ```
- **Check Permissions:** Ensure Lambda has permission to write logs.

---

## Docker & Dependency Issues

### 1. "No module named 'httpx'" (ImportError)
**Symptoms:** Lambda fails with `Runtime.ImportModuleError: Unable to import module 'main': No module named 'httpx'`.
**Root Cause:** Dependencies are not installed in the correct location (`site-packages`) or not copied to the final image.
**Solution:**
- **Use `UV_SYSTEM_PYTHON=1`**: Ensure dependencies are installed to system Python, not a venv.
- **Copy `site-packages`**: In multi-stage builds (EKS), explicitly copy the site-packages directory:
  ```dockerfile
  COPY --from=builder /usr/local/lib/python3.14/site-packages /usr/local/lib/python3.14/site-packages
  ```
- **Rebuild without cache**:
  ```bash
  docker build --no-cache ...
  ```

### 2. "exec format error"
**Symptoms:** Container fails to start with `exec format error`.
**Cause:** Architecture mismatch (e.g., running `arm64` image on `x86_64` Lambda).
**Solution:**
- Ensure you are using `scripts/docker-push.sh` which enforces the correct architecture.
- Lambda/EKS must use `arm64`.
- App Runner must use `amd64`.

### 3. Terraform "No Changes" after Docker Rebuild
**Cause:** Terraform only detects changes if the image tag changes. Rebuilding `latest` doesn't trigger an update.
**Solution:**
- Use the timestamped tags generated by `docker-push.sh`.
- Or force update via CLI:
  ```bash
  aws lambda update-function-code --function-name <name> --image-uri <uri>:latest
  ```

---

## Deployment Issues

### 1. "Integration already exists"
**Symptoms:** `setup-terraform-lambda.sh` complains about existing integration.
**Solution:**
- Check `terraform/api-gateway.tf` manually.
- If it's a false positive, you can manually add the module block.

### 2. App Runner Service Stuck in "Create"
**Cause:** Health check failing.
**Solution:**
- Check App Runner logs in AWS Console.
- Ensure your app listens on port 8080 (or configured port).
- Ensure `/health` endpoint returns 200 OK.

---

## Debugging Tips

### 1. View Logs
```bash
# Lambda
aws logs tail /aws/lambda/<function-name> --follow

# API Gateway
aws logs tail /aws/apigateway/<project>-dev --follow
```

### 2. Test Locally
Use Docker to run your container locally before deploying:
```bash
# Lambda (requires RIE)
docker run -p 9000:8080 <image>

# App Runner
docker run -p 8080:8080 <image>
```

### 3. Check Architecture
```bash
# Check image architecture
docker inspect <image> | grep Architecture
```
